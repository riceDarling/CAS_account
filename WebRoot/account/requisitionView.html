<link href="css/select2.css" rel="stylesheet">
<script src="js/select2.js"></script>
<style>.select2{width:362px !important;}</style>
<div class="row">
	<div class="col-md-12">
	<div class="panel panel-cascade">
	
		<div class="panel panel-cascade">
			<div class="panel-heading">
				<h3 class="panel-title">
					申购单
				</h3>
			</div>
			<div class="panel-body " style="border-radius:0;border-top:1px solid #b9c4d5">
				<div class="ro">
					<div class="col-mol-md-offset-2">
						<form class="form-horizontal cascade-forms" method="post" action="#" name="signup_form" id="signup_form" novalidate="novalidate">
							<div class="form-group" style="float:left;width:60%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:150px;padding:7px 0;">标题：</label>
								<div class="col-lg-4 col-md-3" style="width:395px;">
									<input type="text" class="form-control  input-small required" name="title" id="title" readonly="readonly">
								</div>
							</div>
							<div class="form-group" style="float:left;width:40%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:170px;padding:7px 0;">期望到货日期：</label>
								<div class="col-lg-4 col-md-3" style="width:195px;">
									<input size="16" type="text" value="" readonly class="form_datetime form-control" id="receivedate" readonly="readonly" />
								</div>
							</div>
							<div class="form-group" style="float:left;width:60%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:150px;padding:7px 0;">制单人：</label>
								<div class="col-lg-4 col-md-3" style="width:395px;">
									<input type="text" class="form-control" name="" id="maker" readonly="readonly">
								</div>
							</div>
							<div class="form-group" style="float:left;width:40%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:170px;padding:7px 0;">申购日期：</label>
								<div class="col-lg-4 col-md-3" style="width:195px;">
									<input size="16" type="text" value="" readonly class="form_datetime form-control" id="requisitionDate" readonly="readonly">
								</div>
							</div>	
							<div class="form-group" style="float:left;width:60%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:150px;padding:7px 0;">申请原因：</label>
								<div class="col-lg-4 col-md-3" style="width:395px;">
									<input type="text" class="form-control" name="reason" id="reason" readonly="readonly">
								</div>
							</div>
							<div class="form-group" style="float:left;width:40%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:170px;padding:7px 0;">采购部门：</label>
								<div class="col-lg-4 col-md-3" style="width:195px;">
									<input size="16" type="text" value=""  class="form-control" id="office" readonly="readonly">
								</div>
							</div>	
							<div class="form-group" style="float:left;width:62%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:150px;padding:7px 0;">审核人（必填）：</label>
								<div class="col-lg-4 col-md-3" style="width:365px;">
                                	<select  tabindex="1" name="checker" id="checker" class="form-control">
									</select>	
								</div>
							</div>
                            <div class="form-group" style="float:right;width:38%;">
								<label class="col-lg-2 col-md-3 control-label" style="width:90px;padding:7px 0;">备注：</label>
								<div class="col-lg-4 col-md-3" style="width:200px;">
									<input type="text" class="form-control" name="comment" id="comment" >
								</div>
							</div>
                            
							<div class="form-group" style="display:table;background:#eee;width:100%;margin-left:0;margin-right:0;">
								<label class="col-lg-6 col-md-6 control-label"><h3 style="text-align:left;padding:0;margin:0;font-size:15px;font-weight:bold;">申请物资明细表</h3></label>
                                <div class="col-lg-12 col-md-12 tablescrol-container" style="height: 155px;overflow-y:scroll;">
                                    <div class="panel-body " style="padding-left:0;padding-right:0;">
                                        <table class="table table-striped" id="requisitionView_table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th style="">物资编码</th>
                                                    <th>物资名称</th>
                                                    <th>规格型号</th>
                                                    <th>申请数量</th>
                                                    <th>计量单位</th>
                                                    <th>备注信息</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="panel-body tablescrol-container" style="height:115px;overflow-y:scroll;">
                                    <table class="table table-striped " id="requisitionView_act_table">
                                        <thead>
                                            <tr>
                                                <th>申请人</th>
                                                <th>审核人</th>
                                                <th>开始时间</th>
                                                <th>结束时间</th>
                                                <th>结论</th>
                                                <th>意见</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
							</div>
							<div class="form-actions form-actions-btn-label">
                            	<input type="button" value="询价" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="requisitionFormSubmit-uec">
                                <input type="button" value="驳回" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="requisitionFormSubmit-back">
								<input type="button" value="提交" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="requisitionFormSubmit-talk">
                            </div>
						</form>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>



<script>



var userid = $.cookie("login_userid");
	$.ajax( {
		url : IP_config+"admin/getAdminList",
		dataType: "json",
		type: "POST",
		async : false,
		success: function(data) {
			if ( data.success ) {
				var html = "<option value=''></option>";
				for ( i in data.obj ) {
					var admin = data.obj[ i ];
					if(userid==admin.id){
						
					}else{
						html+='<option value="' + admin.id + '">' + admin.userrole + '</option>';
					}
				}
				$( "#checker" ).html( html );
				$("#checker").select2();
			}else{
				$( 'body' ).RemindWoken( data.msg );
			}
		}
	});
	var requisitionView_id = $.cookie("requisitionView_id");
	$.ajax({
		url : IP_config + "accountRequisition/formView",
		dataType : "json",
		data : {
			"requisitionid" : requisitionView_id
		},
		type : "POST",
		async : false,
		success : function( data ) {
	
			if ( data.success ) {
				//获取成功
				if ( data.obj.accountRequisition != null ) {
					var aq = data.obj.accountRequisition;
					$("#title").val( aq.title );
					$("#receivedate").val( aq.receivedate );
					$("#reason").val( aq.reason );
					$("#maker").val(aq.maker);
					$("#requisitionDate").val(aq.requisitionDate);
					$("#office").val(aq.office);
					//$("#checker").val( aq.checker );
				}
				if ( data.obj.detailMapList.length > 0 ) {
					var html = "";
					for ( i in data.obj.detailMapList ) {
						var detail = data.obj.detailMapList[ i ];
						html += '<tr>' + '<td>' + (i+1) + '</td>' + '<td >'
								+ detail.materialNum + '</td>' + '<td>'
								+ detail.materialName + '</td>' + '<td>'
								+ detail.size + '</td>' + '<td>'
								+ detail.quantitiy + '</td>' + '<td>'
								+ detail.name + '</td>' + '<td>'
								+ ( detail.remarks == undefined ? '' : detail.remarks ) + '</td>' + '</tr>';
					}
					$( "#requisitionView_table tbody" ).html( html );
				}
				
				if ( data.obj.actList.length > 0 ) {
					var html = "";
					var _step = data.obj.actList[ data.obj.actList.length - 1 ].step;
					if ( _step == 1 ) {
						$( '.form-actions-btn-label' ).html(
							'<input type="button" nc-value="1" value="同意" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="audit_submit-deil">' +
                            '<input type="button" nc-value="2" value="驳回" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="audit_submit-arg">'
						);
					}
					if ( _step == 2 ) {
						$( '#checker' ).parent().parent().css( 'display' , 'none' );
						$( '.form-actions-btn-label' ).html(
							'<input type="button" value="同意" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="audit_submit-comp">' +
                            '<input type="button" value="驳回" style="float:right;margin-right:15px;font-size:14px;padding:7px 15px;" class="btn bg-primary text-white btn-lg" id="audit_submit-arg">'
						);
					}
					
					$( '#audit_submit-deil' ).click( function () {
						audit_submit('yes' , $( '#audit_submit-deil' ).val());
					} );
					$( '#audit_submit-arg' ).click( function () {
						audit_submit('no' ,$( '#audit_submit-arg' ).val());
					} );
					$( '#audit_submit-comp' ).click( function () {
						audit_submit('end' , $( '#audit_submit-comp' ).val());
					} );
					
					for ( i in data.obj.actList ) {
						var act = data.obj.actList[ i ];
						html += '<tr><td>'
								+ act.requisitionName + '</td>' + '<td>'
								+ ( act.checkerName == undefined ? '' : act.checkerName ) + '</td>' + '<td>'
								+ formatDateTime(act.start_time) + '</td>' + '<td>';
								if(act.end_time!=null){
									html+= formatDateTime(act.end_time) + '</td>' + '<td>';
								}else{
									html+='</td>' + '<td>';
								}
							
								if(act.conclusion==1){
									html+='同意</td>' + '<td>';
								}else if( act.conclusion==0 ){
									html+='不同意</td>' + '<td>';
								}else {
									html+='</td>' + '<td>';
								}
								
								html+= ( act.remarks == undefined ? '' : act.remarks ) + '</td>' + '</tr>';
					}
					$( "#requisitionView_act_table tbody" ).html(html);
				}

			} else {
				//获取信息提示
				$( 'body' ).RemindWokenError( data.msg );
			}
		}
	});
	
	//提交
	$( '#requisitionFormSubmit-talk' ).click( function () {
		$( 'body' ).RemindWokenSelect({
			title : '确定提交？',
			istrue : function () {
				if ( $( '#checker' ).val() == '' ) {
					$( 'body' ).RemindWoken( '必须选择审核人/询价人' );
					return;
				}
				var data = {
					id : requisitionView_id,
					checker : $( '#checker' ).val(),
					updateBy : $.cookie("login_userid"),
					update : new Date().format( 'yyyy-MM-dd hh:mm:ss' )
				};
				$.ajax( {
					url : IP_config + "accountRequisition/save",
					dataType : "json",
					contentType:"application/json;charset=UTF-8",
					data : JSON.stringify( data ),
					type : "POST",
					success : function( data ) {
						$( 'body' ).RemindWokenSuccess( '操作成功' );
						$.ajax( {
							url : IP_config + "accountRequisition/selectView",
							dataType: "json",
							type: "POST",
							data : {
								title : $("#pName").val(),
								checker : userid,
								procInsId : $( '#procInsId' ).val(),
								startTime : $( '#startTime' ).val(),
								endTime : $( '#endTime' ).val(),
								pageSize : 30,
								currentPage : 1
							},
							async : false,
							success: function( data1 ) {
								
								var data_total = data1.obj.totalCount;
								var table_data = data1.obj.list;
								
								dataTable( table_data , data_total );
							}
						});
						setTimeout(function(){
							$(".account-panel").remove();
						},600);
					},
					error : function (  ) {
						$( 'body' ).RemindWokenError( '操作失败' );
					}
				} );
			}
		});
	} );
	
	//询价
	$( '#requisitionFormSubmit-uec' ).click( function () {
		$( 'body' ).RemindWokenSelect({
			title : '确定询价？',
			istrue : function () {
				if ( $( '#checker' ).val() == '' ) {
					$( 'body' ).RemindWoken( '必须选择审核人/询价人' );
					return;
				}
				var data = {
					id : requisitionView_id,
					inquiry : $( '#checker' ).val(),
					updateBy : $.cookie("login_userid"),
					checker : $( '#checker' ).val(),
					update : new Date().format( 'yyyy-MM-dd hh:mm:ss' ),
					procInsId : 'end',
					Conclusion : 'end'
				};
				$.ajax( {
					url : IP_config + "accountRequisition/saveaudit",
					dataType : "json",
					contentType:"application/json;charset=UTF-8",
					data : JSON.stringify( data ),
					type : "POST",
					success : function( data ) {
						$( 'body' ).RemindWokenSuccess( '操作成功' );
						$.ajax( {
							url : IP_config + "accountRequisition/selectView",
							dataType: "json",
							type: "POST",
							data : {
								title : $("#pName").val(),
								checker : userid,
								procInsId : $( '#procInsId' ).val(),
								startTime : $( '#startTime' ).val(),
								endTime : $( '#endTime' ).val(),
								pageSize : 30,
								currentPage : 1
							},
							async : false,
							success: function( data1 ) {
								
								var data_total = data1.obj.totalCount;
								var table_data = data1.obj.list;
								
								dataTable( table_data , data_total );
							}
						});
						setTimeout(function(){
							$(".account-panel").remove();
						},600);
					},
					error : function (  ) {
						$( 'body' ).RemindWokenError( '操作失败' );
					}
				} );
			}
		});
	} );
	//退回
	$( '#requisitionFormSubmit-back' ).click( function () {
		$( 'body' ).RemindWoken( '此功能待完善' );
	} );
	
	
	function audit_submit(conclusion , _text){
		if ( $( '#audit_submit-deil' ).attr( 'nc-value' ) == 1 && conclusion == 'yes' ) {
			if ( $( '#checker' ).val() == null || $( '#checker' ).val() == '' ) {
				$( 'body' ).RemindWoken( '必须选择审核人' );
				return;
			}
		}
		$( 'body' ).RemindWokenSelect({
			title : '确定' + _text + '？',
			istrue : function () {
				$.ajax(IP_config+"accountRequisition/saveAudit", {
					dataType: "json",
					data:{
						"id":requisitionView_id,
						"conclusion":conclusion,
						"checker":$("#checker").val(),
						"comment":$( '#comment' ).val()
					},
					xhrFields: {
						withCredentials: true
					},
					type: "POST",
					success: function(data) {
						//console.log(data);
						if(data.success){
							
							//获取成功
							$( 'body' ).RemindWokenSuccess( data.msg );
							$.ajax( {
							url : IP_config + "accountRequisition/selectView",
							dataType: "json",
							type: "POST",
							data : {
								title : $("#pName").val(),
								checker : userid,
								procInsId : $( '#procInsId' ).val(),
								startTime : $( '#startTime' ).val(),
								endTime : $( '#endTime' ).val(),
								pageSize : 30,
								currentPage : 1
							},
							async : false,
							success: function( data1 ) {
								
								var data_total = data1.obj.totalCount;
								var table_data = data1.obj.list;
								
								dataTable( table_data , data_total );
							}
							});
							setTimeout(function(){
								$(".account-panel").remove();
							},600);
						}else{
							//获取失败提示
							$( 'body' ).RemindWokenError( data.msg );
						}
					}
				});
			}
		});
		
	};
	
</script>