<link href="bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<script src="bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="bootstrap-datetimepicker/js/bootstrap-datetimepicker.zh-CN.js"></script>
<div class="col-md-12">
	<div class="panel panel-cascade">
		<div class="panel-heading">
			<h3 class="panel-title">
				<i class="fa fa-pencil-square"></i><a href_1="accountContractList.html"> 合同列表</a> <i class="fa fa-pencil-square"></i>合同添加
			</h3>
		</div>
		<div class="panel-body">
			<form action class="form-horizontal row-border">
				<div class="form-group">
					<label class="col-sm-3 control-label">申购标题：</label> <select name="purchasenumtitle" id="purchasenumtitle">
					</select>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">供应商：</label> <select name="supplier" id="supplier">
						<option value="">请选择</option>
					</select>
				</div>
			</form>
		</div>
		<div class="panel-footer">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
					<input id="btnSubmit" class="btn btn-primary" type="button" value="查询" />
				</div>
			</div>
		</div>
	</div>
</div>
<div class="col-md-12">
	<div class="panel">
		<ul class="nav nav-tabs">
			<li class="active"><a href="#">合同编辑</a></li>
		</ul>
		<div class="panel-body">
			<form>
				<div class="control-group">
					<label class="control-label">合同编号：</label>
					<div class="controls">
						<input name="contractnum" readonly="true" htmlEscape="false" maxlength="32" id="contractnum" class="form-control" /> <input type="button" value="自动生成" id="automatic" />
					</div>
				</div>
				<div class="control-group" hidden="true">
					<label class="control-label">采购单号：</label>
					<div class="controls">
						<input name="purchasenum" id="purchasenum" htmlEscape="false" maxlength="32" class="form-control" />
					</div>
				</div>
				<div class="control-group" hidden="true">
					<label class="control-label">供应商编号：</label>
					<div class="controls">
						<input name="supplierNum" id="supplierNum" htmlEscape="false" maxlength="32" class="form-control" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">合同名称：</label>
					<div class="controls">
						<input name="contracttitle" id="contracttitle" htmlEscape="false" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">纸质合同编号：</label>
					<div class="controls">
						<input name="papercontract" id="papercontract" htmlEscape="false" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">乙方：</label>
					<div class="controls">
						<input name="caigouname" id="caigouname" htmlEscape="false" maxlength="255" readonly="true" class="form-control" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">采购原料：</label>
					<table id="contentTable" class="table table-striped table-bordered table-condensed" style="width:70%;">
						<thead>
							<tr>
								<th>物资名称</th>
								<th>规格型号</th>
								<th>采购数量</th>
								<th>采购单价</th>
								<th>采购金额</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
				<div class="control-group">
					<label class="control-label">签订日期：</label>
					<div class="controls">
						<input size="16" type="text" readonly="true" class="form_datetime form-control" name="createdate" id="createdate" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">附件上传：</label>
					<div class="controls">
						<input name="file" id="file" type="file" htmlEscape="false" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">备注信息：</label>
					<div class="controls">
						<textarea name="remarks" id="remarks" htmlEscape="false" rows="4" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="form-actions">
					<input id="submitbtn" class="btn btn-primary" type="button" value="保 存" /><input id="btnCancel" class="btn" type="button" value="返 回" />
				</div>
			</form>
		</div>
	</div>
</div>
<script type="text/javascript">
	$("[href_1]").click(function() {
		$("#index_content").load($(this).attr("href_1"));
	});
	$(".form_datetime").datetimepicker({
		language : 'zh-CN',
		minView : "month", //选择日期后，不会再跳转去选择时分秒 
		format : 'yyyy-mm-dd',
		todayBtn : 1,
		autoclose : 1,
	});
	$(function() {
		//获取采购订货单标题
		$.ajax({
			url : "http://" + IP_config + "/account/accountPurchase/getAccountPurchaseTitle",
			type : "post",
			success : function(data) {
				var html = "<option value=''>请选择</option>";
				for (i in data.obj) {
					html += "<option value="+data.obj[i].title+">" + data.obj[i].title + "</option>";
				}
				$("#purchasenumtitle").html(html);

			}
		});
	});
	$("#automatic").click(function() {
		var ordernum = "30-";
		var date = new Date();
		var year = date.getFullYear();
		var month = date.getMonth() + 1;
		var day = date.getDate();
		if (month < 10) {
			month = "0" + month;
		}
		if (day < 10) {
			day = "0" + day;
		}
		ordernum = ordernum + year + month + day + "-";
		var ordernumRandom = "";
		for (var i = 0; i < 5; ++i) {
			var num = Math.random();
			num = parseInt(num * 10);
			ordernumRandom += num;
		}
		ordernum += ordernumRandom;
		$("#contractnum").val(ordernum);
	});
	function money() {
		$("#contentTable>tbody>tr td:nth-child(5)").find("input").val($("#contentTable>tbody>tr td:nth-child(3)").find("input").val() * $("#contentTable>tbody>tr td:nth-child(4)").find("input").val());
	}
	$("#btnCancel").click(function() {
		$("#index_content").load("accountContractList.html");
	});
	//根据采购标题查询采购数据
	$("#purchasenumtitle").click(function() {
		var purchasenumtitle = $("#purchasenumtitle").val();
		if (purchasenumtitle != null && purchasenumtitle != "") {
			//获取采购订货单列表供应商数据列表
			$.ajax({
				url : "http://" + IP_config + "/account/accountPurchase/getAccountSupplierByPurchasenumtitle",
				type : "post",
				data : {
					"purchasenumtitle" : purchasenumtitle
				},
				async : false,
				success : function(data) {
					var html = "";
					for (i in data.obj) {
						html += "<option value='"+data.obj[i].packway+"' name='"+data.obj[i].transport+"'  class='"+data.obj[i].materialcode+"'>" + data.obj[i].suppliercode + "</option>";
					}
					$("#supplier").html(html);

				}
			})
		}
	});
	//选择供应商获取详细数据
	$("#btnSubmit").click(function() {
		//采购单号
		$("#purchasenum").val($("#supplier").find("option:selected").val());
		//供应商编号
		$("#supplierNum").val($("#supplier").find("option:selected").attr("name"))
		//乙方
		$("#caigouname").val($("#supplier").find("option:selected").text());
		var dataline = {};
		dataline["suppliercode"] = $("#supplier").find("option:selected").attr("name");
		dataline["materialcode"] = $("#supplier").find("option:selected").attr("class");
		//获取采购具体原料列表
		$.ajax({
			url : "http://" + IP_config + "/account/accountPurchase/getAccountSupplierByPurchasenum",
			type : "post",
			data : dataline,
			async : false,
			success : function(data) {
				$("#contentTable>tbody").empty();
				for (i in data.obj) {
					var html = "<tr><td>" + data.obj[i].materialcode + "</td><td>" + data.obj[i].suppliercode + "</td><td><input name='quantity'   onchange='money()' /></td><td><input name='unitprice'   onchange='money()' /></td><td><input name='totlemoney' /></td></tr>";
					$("#contentTable>tbody").html(html);
				}

			}
		})
	})
	//提交保存合同
	$("#submitbtn").click(function() {
		if ($("#contractnum").val() != null && $("#contractnum").val() != "") {
			if ($("#contracttitle").val() != null && $("#contracttitle").val() != "") {
				$("#submitbtn").attr("disabled", true);
				var dataline = {};
				dataline["purchasenum"] = $("#purchasenum").val();
				dataline["supplierNum"] = $("#supplierNum").val();
				dataline["contractnum"] = $("#contractnum").val();
				dataline["papercontract"] = $("#papercontract").val();
				dataline["contracttitle"] = $("#contracttitle").val();
				dataline["caigouname"] = $("#caigouname").val();
				dataline["createdate"] = $("#createdate").val();
				dataline["quantity"] = $("#contentTable>tbody>tr td:nth-child(3)").find("input").val();
				dataline["unitprice"] = $("#contentTable>tbody>tr td:nth-child(4)").find("input").val();
				dataline["money"] = $("#contentTable>tbody>tr td:nth-child(5)").find("input").val();
				dataline["file"] = $("#file").val();
				dataline["remarks"] = $("#remarks").val();
				$.ajax({
					url : "http://" + IP_config + "/account/accountContractController/save",
					type : "post",
					data : dataline,
					async : false
				})
				if (dataline != null && dataline != "") {
					layer.alert("保存成功");
					$("#index_content").load("accountContractList.html");
				} else {
					layer.alert("保存失败");
					$("#index_content").load("accountContracFormhtml");
				}
			} else {
				layer.alert("请添写合同名称!");
			}
		} else {
			layer.alert("请添写合同编号!");
		}
	})
</script>
