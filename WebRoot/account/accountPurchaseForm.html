<link href="css/select2.css" rel="stylesheet">
<script src="js/select2.js"></script>
<script src="lib/js/purchaseForm.js"></script>
<style>
	.panel-cascade > .panel-body{border:none;}
	.combo-select{width:133px !important;;}
	.combo-input.text-input{width:130px;}
</style>
<div class="col-md-12">
	<div class="panel panel-cascade">
		<div class="panel-heading">
			<h3 class="panel-title">
				添加订货单
			</h3>
		</div>
		<div class="panel-body">
            <label class="col-lg-1 col-md-2 control-label" style="width: 170px;padding-right:0;text-align:right;margin-top:7px;">订货单标题（必填）：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;padding-left:0;">
                <input name="supplier" type="text" htmlEscape="false" style="width:155px;padding-left:0;margin-left:0;" class="form-control" id="title" />
            </div>
            <label class="col-lg-1 col-md-2 control-label" style="width: 135px;padding-right:0;text-align:right;margin-top:7px;">合同（必选）：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;width:155px;padding-left:0;">
                <select name="status" class="form-control" style="width:155px;padding-left:0;margin-left:0;" id="accountPurchaseForm_contract">
                    <option value="">请选择</option>
                </select>
            </div>
            <label class="col-lg-1 col-md-3 control-label" style="margin-top: 7px;width:150px;padding-left: 0;padding-right: 0;text-align:right">审核人（必选）：</label>
			<div class="col-lg-3 col-md-3" style="margin-left:0;padding-left:0;width:130px;">
                <select  tabindex="1" name="checker" style="width:130px;padding-left:0;margin-left:0;" id="accountPurchaseForm_checker" class="form-control">
                     <option value=""></option>
                 </select>	
			</div>
		</div>
		<div class="panel-body">
            <label class="col-lg-1 col-md-2 control-label" style="width: 170px;padding-right:0;text-align:right;margin-top:7px;">供应商名称：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;padding-left:0;">
                <input name="supplier" type="text" htmlEscape="false" style="width:155px;padding-left:8px;margin-left:0;" readonly class="form-control" id="supplier" />
            </div>
            <label class="col-lg-1 col-md-2 control-label" style="width: 130px;padding-right:0;text-align:right;margin-top:7px;">供应商编码：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;width:160px;padding-left:0;">
                <input name="supplier" type="text" htmlEscape="false" style="width:162px;padding-left:8px;margin-left:0;" readonly class="form-control" id="supplierNum" />
            </div>
            <label class="col-lg-1 col-md-3 control-label" style="margin-top: 7px;width:150px;padding-left: 0;padding-right: 0;text-align:right">制单人（必选）：</label>
			<div class="col-lg-3 col-md-3" style="margin-left:0;padding-left:0;width:130px;">
               <input name="supplier" type="text" htmlEscape="false" style="width:155px;padding-left:8px;margin-left:0;"  class="form-control" id="maker" />
			</div>
		</div>
		<div class="panel-body">
            <label class="col-lg-1 col-md-2 control-label" style="width: 170px;padding-right:0;text-align:right;margin-top:7px;">纸质合同编号：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;width:160px;padding-left:0;">
                <input name="supplier" type="text" htmlEscape="false" style="width:155px;padding-left:8px;margin-left:0;" readonly class="form-control" id="papercontract" />
            </div>
            <label class="col-lg-1 col-md-3 control-label" style="margin-top: 7px;width:125px;padding-left: 0;padding-right: 0;text-align:right">合同编号：</label>
			<div class="col-lg-3 col-md-3" style="margin-left:0;padding-left:0;width:130px;">
               <input name="supplier" type="text" htmlEscape="false" style="width:165px;padding-left:8px;margin-left:0;" readonly class="form-control" id="contractnum" />
			</div>
			 <label class="col-lg-1 col-md-2 control-label" style="width: 180px;padding-right:0;text-align:right;margin-top:7px;">制单日期（必填）：</label>
            <div class="col-lg-2 col-md-2" style="margin-left:0;padding-left:0;">
                <input name="supplier" type="text" htmlEscape="false" style="width:155px;padding-left:8px;margin-left:0;" readonly class="form_datetime form-control" id="makeDate" />
            </div>
		</div>
		<div class="panel-body">
			<table class="table table-bordered table-condensed table-hover">
				<thead>
					<tr>
						<th class="visible-lg">物资编号</th>
						<th class="visible-lg">物资名称</th>
						<th class="visible-lg">型号</th>
						<th class="visible-lg">计量单位</th>
						<th class="visible-lg">单价</th>
						<th class="visible-lg">数量</th>
						<th class="visible-lg">总价</th>
						<th class="visible-lg">备注</th>
					</tr>
				</thead>
				<tbody id="secondPageTbody">
					
				</tbody>
			</table>
			
			<div class="col-lg-12 col-sm-6 col-sm-offset-11">
			<input id="accountPurchaseSubmit" class="btn btn-primary" type="button" value="提交" />
			</div>
		</div>
		
	</div>
</div>
<!-- <div class="form-group">
	<label class="col-lg-1 col-md-3 control-label" style="margin-top: 7px;">审核人(下一节点办理人)：</label>
		<div class="col-lg-3 col-md-3">
			<select  tabindex="1" name="checker" id="accountPurchaseForm_checker" class="form-control">
				 <option value=""></option>
			 </select>	
		</div>
</div> -->
<!-- <div class="panel-footer">
	<div class="row">
		<div class="col-sm-6 col-sm-offset-11">
			<input id="accountPurchaseSubmit" class="btn btn-primary" type="button" value="提交" />
		</div>
	</div>
</div> -->
<script>
	var userid = $.cookie("login_userid");
	/* $("[href_1]").click(function() {
		$("#index_content").load($(this).attr("href_1"));
	}); */

	$(".form_datetime").datetimepicker({
		language:  'zh-CN', 
		minView: "month", //选择日期后，不会再跳转去选择时分秒 
	    format: 'yyyy-mm-dd',
	    todayBtn:  1,
	    autoclose: 1
	});
	    
	
	
	$.ajax({
		url : IP_config+"admin/getAdminList",
		dataType: "json",
		xhrFields: {
			withCredentials: true
		},
		type: "GET",
		success: function(data) {
			//console.log(data);
			if(data.success){
				//获取成功
				//layer.alert(data.msg);
				var html="<option value=''></option>";
				for (i in data.obj) {
					var admin = data.obj[i];
					if(userid==admin.id){
						
					}else{
						html+='<option value="' + admin.id + '">' + admin.userrole + '</option>';
					}
				}
				$("#accountPurchaseForm_checker").html(html);
				$("#accountPurchaseForm_checker").select2();
			}else{
				//获取失败提示
				$( 'body' ).RemindWoken( data.msg );
			}
		}
	});
	//获取合同标题列表
	$.ajax({
		url : IP_config+"accountContractController/findAllTitle",
		dataType: "json",
		xhrFields: {
			withCredentials: true
		},
		type: "GET",
		success: function(data) {
			//console.log(data);
			if(data.success){
				//获取成功
				//layer.alert(data.msg);
				var html="<option value=''>请选择</option>";
				for (i in data.obj) {
					var contract = data.obj[i];
					html+='<option value="'+contract.id+'" supplierNum="'+contract.supplierNum+'"  contractnum="'+contract.contractnum+'" papercontract="'+contract.papercontract+'" supplier="'+contract.supplier+'">'+contract.contractTitle+'</option>';
				}
				$("#accountPurchaseForm_contract").html(html);
				$("#accountPurchaseForm_contract").select2();
			}else{
				//获取失败提示
				$( 'body' ).RemindWoken( data.msg );
			}
		}
	});
	$("#accountPurchaseForm_contract").change(function(){
		
		//获取供应商名称、供应商编码、纸质合同编号、合同编号
		var oSupplier = $(this).children('option:selected').attr("supplier");
		var oSupplierNum = $(this).children('option:selected').attr("supplierNum");
		var oPapercontract = $(this).children('option:selected').attr("papercontract");
		var oContractnum = $(this).children('option:selected').attr("contractnum");
		//赋值
		$("#supplier ").val(oSupplier);
		$("#supplierNum").val(oSupplierNum);
		$("#papercontract").val(oPapercontract);
		$("#contractnum").val(oContractnum);
		
		
		var contract_id=$(this).val();
		//获取合同子表详细信息
		$.ajax({
			url : IP_config+"accountContractController/getByContractId",
			dataType: "json",
			xhrFields: {
				withCredentials: true
			},
			type: "GET",
			data:{
				"id":contract_id
			},
			success: function(data) {
				//console.log(data);
				if(data.success){
					//获取成功
					//layer.alert(data.msg);
					var html="";
					for (i in data.obj) {
						var detail = data.obj[i];
						html+='<tr><td>';
						html+=detail.materialcode+'</td><td>';
						html+=detail.materialname+'</td><td>';
						html+=detail.size+'</td><td>';
						html+=detail.unitname+'</td><td>';
						html+=detail.unitprice+'</td><td>';
						html+='<input type="text" class="input-small required form-control money" name="quantity" >'+'</td><td>';
						html+='<input type="text" class="input-small required form-control" name="totlemoney" readonly>'+'</td><td>';
						html+='<input type="text" class="input-small required form-control" >'+'</td></tr>';
						//html+='<option value="'+contract.id+'">'+contract.contractTitle+'</option>';
					}
					$("#secondPageTbody").html(html);
				}else{
					//获取失败提示
					$( 'body' ).RemindWoken( data.msg );
				}
			}
		});
	});
	
	$("#secondPageTbody").on("change",".money",function(){
		var	quantity=$(this).val();
		var unitprice=$(this).parent().parent().children("td").eq(4).text();
		var totlemoney=quantity*unitprice;
		if(!isNaN(totlemoney)){
			$(this).parent().parent().children("td").eq(6).find("input").val(totlemoney.toFixed(2));
		}
	});
	
</script>