
<div class="col-lg-12 col-md-12" >
	<div class="panel panel-cascade" style="margin-bottom:0;border-radius:0;border:0;">
		<div class="panel-heading">
			<h3 class="panel-title">
				<i class="fa fa-pencil-square"></i>修改合同单
			</h3>
		</div>
		<div class="panel-body" style="border:0;border-top:1px solid #ccc;">
			<form action class="form-horizontal row-border">
				<div class="form-group">
					<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;">申购单：</label> 
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<select class="form-control" name="purchasenumtitle" readonly="readonly" id="title-purchasenumtitle" ></select>
					</div>
					<label class="col-lg-1 col-sm-3 control-label" style="width: 165px !important;padding-right:0;">供应商：</label> 
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<select class="form-control" readonly name="supplier" id="titles-supplier">
							
						</select>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<div class="col-lg-12 col-md-12">
	<div class="panel" style="border:0;border-radius:0;">
		<div class="panel-body" style="padding:0;padding-bottom:10px;">
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
					<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">合同编号：</label> 
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="title-contractnum"  htmlEscape="false" maxlength="32" id="title-contractnum" class="form-control" readonly style="width:305px !important;display:inline-block;" />
					</div>
				</div>
				<div class="control-group" hidden="true" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">采购单号：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="purchasenum" id="title-purchasenum" htmlEscape="false" style="width:305px;" maxlength="32" class="form-control" />
					</div>
				</div>
				<div class="control-group" hidden="true" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">供应商编号：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="supplierNum" id="title-supplierNum" htmlEscape="false" style="width:305px;" maxlength="32" class="form-control" />
					</div>
				</div>
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">合同名称（必填）：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="contracttitle" id="title-contracttitle" htmlEscape="false" style="width:305px;" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">纸质合同编号：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="papercontract" id="title-papercontract" htmlEscape="false" style="width:305px;" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">乙方：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input name="caigouname" id="title-caigouname" htmlEscape="false" style="width:305px;" maxlength="255" readonly="true" class="form-control" />
					</div>
				</div>
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">签订日期（必选）：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<input size="16" type="text" readonly="true" style="width:305px;" class="form_datetime form-control" name="createdate" id="title-createdate" />
					</div>
				</div>
				<!-- <div class="control-group">
					<label class="control-label">附件上传：</label>
					<div class="controls">
						<input name="file" id="file" type="file" htmlEscape="false" maxlength="255" class="form-control" />
					</div>
				</div> -->
				<div class="control-group" style="width:50%; float:left;margin-bottom:15px;">
                	<label class="col-lg-1 col-sm-3 control-label" style="width: 150px !important;padding-right:0;text-align:right;margin-top:7px;">备注信息：</label>
					<div class="col-lg-3 col-md-6" style="width:320px;padding-left:0;">
						<textarea name="remarks" id="title-remarks" htmlEscape="false" style="width:305px;" rows="4" maxlength="255" class="form-control" />
					</div>
				</div>
				<div class="control-group" style="padding-left:15px;">
					<label class="control-label">采购原料：</label>
					<table id="contentTable" class="table table-striped table-bordered table-condensed" style="width:940px;table-layout:fixed"">
						<thead>
							<tr>
								<th>物资名称</th>
								<th>规格型号</th>
								<th>单位</th>
								<th>采购数量</th>
								<th>采购单价</th>
								<th>采购金额</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
				<div class="form-actions">
					<input id="submitbtn" style="margin-right:5px;float:right;" class="btn btn-primary" type="button" value="保 存" />
				</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	
	$(".form_datetime").datetimepicker({
		language : 'zh-CN',
		minView : "month", //选择日期后，不会再跳转去选择时分秒 
		format : 'yyyy-mm-dd',
		todayBtn : 1,
		autoclose : 1,
	});
	function money() {
		var len = $("#contentTable>tbody>tr").length;
		for (var i = 0; i < len; i++) {
			var quantity = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(3) input").val();
			var unitprice = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(4) input").val();
			var money = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(5) input").val(quantity * unitprice);
		}
	}
	
	var _accountContract_id = $.cookie("accountContract_id"),
		_accountContract_title = $.cookie("accountContract_title"),
		_accountContract_supplier = $.cookie("accountContract_supplier");
	
	
		if (_accountContract_id != "null" && _accountContract_title != "null") {
			//$("#payId").val( _accountContract_id );
			
			var _html = "<option value='" + _accountContract_id + "' >" + _accountContract_title + "</option>";
			$("#title-purchasenumtitle").html( _html );
			var _htmls = "<option value='" + _accountContract_supplier + "' >" + _accountContract_supplier + "</option>";
			
			$("#titles-supplier").html( _htmls );
			$.ajax({
				url :  IP_config + "accountContractController/getById",
				type : "post",
				dataType : "json",
				data : {
					"id" : _accountContract_id
				},
				async : false,
				success : function(data) {
					if (data.success && data.obj != null && data.obj != "") {
						$("#title-contractnum").val(data.obj.contractnum);
						$("#title-papercontract").val(data.obj.papercontract);
						$("#title-purchasenum").val(data.obj.purchasenum);
						$("#title-supplierNum").val(data.obj.supplierNum);
						$("#title-contracttitle").val(data.obj.contracttitle);
						$("#title-caigouname").val(data.obj.caigouname);
						$("#title-createdate").val(data.obj.createdate);
						//$("#file").val(data.obj.file);
						$("#title-remarks").val(data.obj.remarks);
						$("#title-status").val(data.obj.status);
					}
				}
			});
			$.ajax({
				url :  IP_config + "accountContractController/getByContractId",
				type : "post",
				data : {
					"id" : _accountContract_id
				},
				async : false,
				success : function(data) {
					$("#contentTable tbody").empty();
					var html = "";
					for (i in data.obj) {
						html += "<tr><td  name='"+data.obj[i].materialcode+"'>" + data.obj[i].materialname + "</td><td>" + data.obj[i].size + "</td><td>" + data.obj[i].unitname + "</td><td>" + "<input style='width:100%;' type='text'  onchange='money()' value='" + data.obj[i].quantity + "' ></td><td>" + "<input style='width:100%;' type='text'  value='" + data.obj[i].unitprice + "'  onchange='money()' ></td><td>" + "<input style='width:100%;' type='text'  value='"+ data.obj[i].money +"'></td></tr>";
					}
					$("#contentTable tbody").html(html);
				}
			})
			$.cookie("accountContract_id", null );
			$.cookie( "accountContract_title" , null )
			$.cookie( "accountContract_supplier" , null )
		}

	//选择供应商获取详细数据
	$("#btnSubmit").click(function() {
		//采购单号
		$("#title-purchasenum").val($("#titles-supplier").find("option:selected").val());
		//供应商编号
		$("#title-supplierNum").val($("#titles-supplier").find("option:selected").attr("name"))
		//乙方
		$("#title-caigouname").val($("#titles-supplier").find("option:selected").text());
		var dataline = {};
		dataline["suppliercode"] = $("#titles-supplier").find("option:selected").attr("name");
		dataline["inquirydetailnum"] = $("#titles-supplier").find("option:selected").attr("class");
		//获取采购具体原料列表
		$.ajax({
			url :  IP_config + "accountInquiry/getAccountSupplierByPurchasenum",
			type : "post",
			data : dataline,
			async : false,
			success : function(data) {
				$("#contentTable>tbody").empty();
				var html = "";
				for (i in data.obj) {
					html += "<tr><td name='"+data.obj[i].materialcode+"'>" + data.obj[i].materialname + "</td><td>" + data.obj[i].size + "</td><td>" + data.obj[i].unitname + "</td><td><input type='text' class='form-control'   onchange='money()' /></td><td><input type='text' class='form-control'  onchange='money()' /></td><td><input type='text' class='form-control' /></td></tr>";
				}
				$("#contentTable>tbody").html(html);
			}
		})
	})
	//提交保存合同
	$("#submitbtn").click(function() {
		$( 'body' ).RemindWokenSelect({
			title : '确定保存？',
			istrue : function () {
				if ($("#title-contractnum").val() != null && $("#title-contractnum").val() != "") {
					if ($("#title-contracttitle").val() != null && $("#title-contracttitle").val() != "") {
						$("#submitbtn").attr("disabled", true);
						var accountContract = {};
						accountContract.id = _accountContract_id;
						accountContract.contractnum = $("#title-contractnum").val();
						accountContract.papercontract = $("#title-papercontract").val();
						accountContract.contracttitle = $("#title-contracttitle").val();
						accountContract.purchasenum = $("#title-purchasenum").val();
						accountContract.supplierNum = $("#title-supplierNum").val();
						accountContract.caigouname = $("#title-caigouname").val();
						accountContract.createdate = $("#title-createdate").val();
						//accountContract.file = $("#file").val();
						accountContract.remarks = $("#title-remarks").val();
						var len = $("#contentTable>tbody>tr").length;
						var aiArr = new Array();
						for (var i = 0; i < len; i++) {
							var accountContractDetail = {};
							var materialcode = $("#contentTable>tbody>tr:eq("+i+") td:eq(0)").attr("name");
							var materialname = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(0)").text();
							var size = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(1)").text();
							var unitname = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(2)").text();
							var quantity = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(3) input").val();
							var unitprice = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(4) input").val();
							var money = $("#contentTable>tbody>tr:eq(" + i + ") td:eq(5) input").val();
							accountContractDetail.materialcode = materialcode;
							accountContractDetail.materialname = materialname;
							accountContractDetail.size = size;
							accountContractDetail.unitname = unitname;
							accountContractDetail.quantity = quantity;
							accountContractDetail.unitprice = unitprice;
							accountContractDetail.money = money;
							aiArr.push(accountContractDetail);
						}
						accountContract.accountContractDetail = aiArr;
						$.ajax({
							url :  IP_config + "accountContractController/save",
							type : "post",
							contentType : "application/json;charset=UTF-8",
							data : JSON.stringify(accountContract),
							async : false
						});
						$.cookie("accountContract_id", null );
						$.cookie( "accountContract_title" , null )
						$.cookie( "accountContract_supplier" , null )
						if (accountContract != null && accountContract != "") {
							$( 'body' ).RemindWokenSuccess("保存成功");
							$.ajax( {
								url : IP_config + 'accountContractController/selectView',
								dataType: "json",
								type: "POST",
								data :  {
									purchasenumtitle : $("#purchasenumtitle").val(),
									contracttitle : $( '#contracttitle' ).val(),
									status : $( '#procInsId' ).val(),
									beginDate : $( '#startTime' ).val(),
									endDate : $( '#endTime' ).val(),
									pageSize : 30,
									currentPage : 1
								},
								async : false,
								success: function( data1 ) {
								
									if ( data1.success ) {
										var data_total = data1.obj.totalCount;
										var table_data = data1.obj.list;
										if ( data1.obj.list.length < 2 && data1.obj.list[ 0 ].contractnum == null ) {
											data_total = 0;
											table_data = [];
										}
										dataTable( table_data , data_total );
									} else {
										$( 'body' ).RemindWoken( '查询失败' );
									}
								}
							});
							/*setTimeout(function(){
								$(".account-panel").remove();
							},600);*/
						} else {
							$( 'body' ).RemindWokenError("保存失败");
							
						};
					} else {
						$( 'body' ).RemindWoken("请添写合同名称!");
					}
				} else {
					$( 'body' ).RemindWoken("请添写合同编号!");
				}
			}
		});
		
	})

</script>